<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <!-- âœ… Blueprintë³„ ê³ ìœ  CSS ì ìš© -->
    <link rel="stylesheet" href="{{ url_for('portfolio.static', filename='css/mypage.css', v=1) }}">
    
    {% if error %}
    <script>
        alert("{{ error }}");
        window.location.href = "{{ service_urls.auth }}";
    </script>
    {% endif %}
</head>
<body>
    <!-- í—¤ë” êµ¬ì¡° ê°œì„  -->
    <header class="portfolio-header">
        <div class="header-container">
            <h1 class="portfolio-title">ê°€ìƒ ì£¼ì‹ ì‹œë®¬ë ˆì´ì…˜</h1>
            <div class="user-info-box">
                <p class="username">{{ user.username if user else "ë¡œê·¸ì¸ í•„ìš”" }}ë‹˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤</p>
                <div class="balance-display">
                    <span class="balance-krw">{{ "{:,.0f}".format(user['seed_krw']) if user else "0" }} KRW</span>
                    <span class="balance-usd">{{ "{:,.2f}".format(user['seed_usd']) if user else "0.00" }} USD</span>
                </div>
            </div>
            <nav class="portfolio-nav">
                <a href="{{ service_urls.home }}" class="nav-btn">í™ˆ</a>
                <a href="{{ service_urls.exchange }}" class="nav-btn">í™˜ì „í•˜ê¸°</a>
            </nav>
        </div>
    </header>

    <main class="portfolio-main">
        <!-- ë³´ìœ  ìì‚° ì„¹ì…˜ -->
        <section class="asset-section">
            <h2 class="section-title">ğŸ“Š íˆ¬ì ì„±ê³¼ ë¶„ì„</h2>
            <div class="performance-metrics">
                <div class="metric-card total-return">
                    <h3>ì „ì²´ ìˆ˜ìµë¥ </h3>
                    <p class="metric-value">
                        {% if profit_rate_total is defined and profit_rate_total is not none %}
                            {{ "{:,.2f}".format(profit_rate_total) }}%
                        {% else %}
                            -
                        {% endif %}
                    </p>
                </div>
                <div class="metric-card current-rank">
                    <h3>í˜„ì¬ ìˆœìœ„</h3>
                    <p class="metric-value">
                        {% if p_rank is defined and p_rank is not none %}
                            #{{ p_rank }}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                </div>
            </div>
        </section>

        <!-- ë³´ìœ  ì¢…ëª© í…Œì´ë¸” -->
        <section class="holdings-section">
            <h2 class="section-title">ğŸ“¦ ë³´ìœ  ì¢…ëª©</h2>
            {% if portfolio %}
            <div class="holdings-table-container">
                <table class="holdings-table">
                    <thead>
                        <tr>
                            <th class="stock-name">ì¢…ëª©ëª…</th>
                            <th class="quantity">ë³´ìœ ëŸ‰</th>
                            <th class="current-value">í˜„ì¬ ê°€ì¹˜</th>
                            <th class="investment">íˆ¬ìì•¡</th>
                            <th class="return-rate">ìˆ˜ìµë¥ </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for portfolio_item, stock_name in portfolio %}
                        <tr class="holding-item">
                            <td class="stock-name">{{ stock_name }}</td>
                            <td class="quantity">{{ portfolio_item.stock_amount|int }}ì£¼</td>
                            <td class="current-value">{{ "{:,.0f}".format(portfolio_item.total_value) }} KRW</td>
                            <td class="investment">{{ "{:,.0f}".format(portfolio_item.initial_investment) }} KRW</td>
                            <td class="return-rate {% if portfolio_item.profit_rate > 0 %}positive{% elif portfolio_item.profit_rate < 0 %}negative{% else %}neutral{% endif %}">
                                {% if portfolio_item.initial_investment > 0 %}
                                    {% if portfolio_item.real_time_profit_rate is defined %}
                                        {{ "{:+.2f}".format(portfolio_item.real_time_profit_rate) }}%
                                    {% else %}
                                        {{ "{:+.2f}".format(portfolio_item.profit_rate) }}%
                                    {% endif %}
                                {% else %}
                                    0.00%
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">ë³´ìœ  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>
            {% endif %}
        </section>

        <!-- ì£¼ë¬¸ ë‚´ì—­ í…Œì´ë¸” -->
        <section class="order-section">
            <h2 class="section-title">â³ ìµœê·¼ ê±°ë˜ ë‚´ì—­</h2>
            {% if today_orders %}
            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th class="stock-name">ì¢…ëª©</th>
                            <th class="order-type">ìœ í˜•</th>
                            <th class="order-price">ê°€ê²©</th>
                            <th class="quantity">ìˆ˜ëŸ‰</th>
                            <th class="status">ìƒíƒœ</th>
                            <th class="timestamp">ì‹œê°„</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order, stock_name in today_orders %}
                        <tr class="order-item">
                            <td class="stock-name">{{ stock_name }}</td>
                            <td class="order-type {% if order.order_type == 'BUY' %}buy{% else %}sell{% endif %}">
                                {{ "ë§¤ìˆ˜" if order.order_type == "BUY" else "ë§¤ë„" }}
                            </td>
                            <td class="order-price">{{ "{:,.0f}".format(order.target_price) if order.target_price else 'N/A' }} KRW</td>
                            <td class="quantity">{{ order.quantity|int }}ì£¼</td>
                            <td class="status">
                                <span class="status-badge {% if order.status == 'COMPLETED' %}completed{% elif order.status == 'PENDING' %}pending{% else %}canceled{% endif %}">
                                    {{ "ì™„ë£Œ" if order.status == "COMPLETED" else "ëŒ€ê¸°ì¤‘" if order.status == "PENDING" else "ì·¨ì†Œë¨" }}
                                </span>
                            </td>
                            <td class="timestamp">{{ order.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">ìµœê·¼ ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
            {% endif %}
        </section>
    </main>

    <!-- Script ë¶€ë¶„ ê°œì„  -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ì£¼ë¬¸ ì·¨ì†Œ í•¸ë“¤ëŸ¬
        window.cancelOrder = async (orderId) => {
            try {
                const response = await fetch('/api/cancel-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
                location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert(`ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨: ${error.message}`);
            }
        };
    });
    </script>
</body>
</html>
