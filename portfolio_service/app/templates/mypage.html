<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <!-- ✅ Blueprint별 고유 CSS 적용 -->
    <link rel="stylesheet" href="{{ url_for('portfolio.static', filename='css/mypage.css', v=1) }}">
    
    {% if error %}
    <script>
        alert("{{ error }}");
        window.location.href = "{{ service_urls.auth }}";
    </script>
    {% endif %}
</head>
<body>
    <!-- 헤더 구조 개선 -->
    <header class="portfolio-header">
        <div class="header-container">
            <h1 class="portfolio-title">가상 주식 시뮬레이션</h1>
            <div class="user-info-box">
                <p class="username">{{ user.username if user else "로그인 필요" }}님의 포트폴리오</p>
                <div class="balance-display">
                    <span class="balance-krw">{{ "{:,.0f}".format(user['seed_krw']) if user else "0" }} KRW</span>
                    <span class="balance-usd">{{ "{:,.2f}".format(user['seed_usd']) if user else "0.00" }} USD</span>
                </div>
            </div>
            <nav class="portfolio-nav">
                <a href="{{ service_urls.home }}" class="nav-btn">홈</a>
                <a href="{{ service_urls.exchange }}" class="nav-btn">환전하기</a>
            </nav>
        </div>
    </header>

    <main class="portfolio-main">
        <!-- 보유 자산 섹션 -->
        <section class="asset-section">
            <h2 class="section-title">📊 투자 성과 분석</h2>
            <div class="performance-metrics">
                <div class="metric-card total-return">
                    <h3>전체 수익률</h3>
                    <p class="metric-value">
                        {% if profit_rate_total is defined and profit_rate_total is not none %}
                            {{ "{:,.2f}".format(profit_rate_total) }}%
                        {% else %}
                            -
                        {% endif %}
                    </p>
                </div>
                <div class="metric-card current-rank">
                    <h3>현재 순위</h3>
                    <p class="metric-value">
                        {% if p_rank is defined and p_rank is not none %}
                            #{{ p_rank }}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                </div>
            </div>
        </section>

        <!-- 보유 종목 테이블 -->
        <section class="holdings-section">
            <h2 class="section-title">📦 보유 종목</h2>
            {% if portfolio %}
            <div class="holdings-table-container">
                <table class="holdings-table">
                    <thead>
                        <tr>
                            <th class="stock-name">종목명</th>
                            <th class="quantity">보유량</th>
                            <th class="current-value">현재 가치</th>
                            <th class="investment">투자액</th>
                            <th class="return-rate">수익률</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for portfolio_item, stock_name in portfolio %}
                        <tr class="holding-item">
                            <td class="stock-name">{{ stock_name }}</td>
                            <td class="quantity">{{ portfolio_item.stock_amount|int }}주</td>
                            <td class="current-value">{{ "{:,.0f}".format(portfolio_item.total_value) }} KRW</td>
                            <td class="investment">{{ "{:,.0f}".format(portfolio_item.initial_investment) }} KRW</td>
                            <td class="return-rate {% if portfolio_item.profit_rate > 0 %}positive{% elif portfolio_item.profit_rate < 0 %}negative{% else %}neutral{% endif %}">
                                {% if portfolio_item.initial_investment > 0 %}
                                    {% if portfolio_item.real_time_profit_rate is defined %}
                                        {{ "{:+.2f}".format(portfolio_item.real_time_profit_rate) }}%
                                    {% else %}
                                        {{ "{:+.2f}".format(portfolio_item.profit_rate) }}%
                                    {% endif %}
                                {% else %}
                                    0.00%
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">보유 종목이 없습니다</p>
            {% endif %}
        </section>

        <!-- 주문 내역 테이블 -->
        <section class="order-section">
            <h2 class="section-title">⏳ 최근 거래 내역</h2>
            {% if today_orders %}
            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th class="stock-name">종목</th>
                            <th class="order-type">유형</th>
                            <th class="order-price">가격</th>
                            <th class="quantity">수량</th>
                            <th class="status">상태</th>
                            <th class="timestamp">시간</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order, stock_name in today_orders %}
                        <tr class="order-item">
                            <td class="stock-name">{{ stock_name }}</td>
                            <td class="order-type {% if order.order_type == 'BUY' %}buy{% else %}sell{% endif %}">
                                {{ "매수" if order.order_type == "BUY" else "매도" }}
                            </td>
                            <td class="order-price">{{ "{:,.0f}".format(order.target_price) if order.target_price else 'N/A' }} KRW</td>
                            <td class="quantity">{{ order.quantity|int }}주</td>
                            <td class="status">
                                <span class="status-badge {% if order.status == 'COMPLETED' %}completed{% elif order.status == 'PENDING' %}pending{% else %}canceled{% endif %}">
                                    {{ "완료" if order.status == "COMPLETED" else "대기중" if order.status == "PENDING" else "취소됨" }}
                                </span>
                            </td>
                            <td class="timestamp">{{ order.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="no-data">최근 거래 내역이 없습니다</p>
            {% endif %}
        </section>
    </main>

    <!-- Script 부분 개선 -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // 주문 취소 핸들러
        window.cancelOrder = async (orderId) => {
            try {
                const response = await fetch('/api/cancel-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                alert('주문이 취소되었습니다');
                location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert(`주문 취소 실패: ${error.message}`);
            }
        };
    });
    </script>
</body>
</html>
