name: Build and Push Changed Services to ECR

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [auth_service, stock_kr_service, exchange_service, portfolio_service]

    env:
      AWS_REGION: ap-northeast-2
      ECR_REGISTRY: 707677861059.dkr.ecr.ap-northeast-2.amazonaws.com
      IMAGE_TAG: latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Check changes and build/push service if needed
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          if echo "$CHANGED_FILES" | grep -qE '(^.env$|^config.py$|^db.py$|^auth_service/|^stock_kr_service/|^exchange_service/|^portfolio_service/)'; then
            for FILE in $CHANGED_FILES; do
              if [[ "$FILE" == ".env" || "$FILE" == "config.py" || "$FILE" == "db.py" ]]; then
                docker build -t $ECR_REGISTRY/${{ matrix.service }}:$IMAGE_TAG ./${{ matrix.service }}
                docker push $ECR_REGISTRY/${{ matrix.service }}:$IMAGE_TAG
                break
              elif [[ "$FILE" == "${{ matrix.service }}/"* ]]; then
                docker build -t $ECR_REGISTRY/${{ matrix.service }}:$IMAGE_TAG ./${{ matrix.service }}
                docker push $ECR_REGISTRY/${{ matrix.service }}:$IMAGE_TAG
                break
              fi
            done
          fi
